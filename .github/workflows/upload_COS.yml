name: "upload_COS"

###############################################################################
# This ci packages the repository files and uploads them to 
# the Tencent cloud storage bucket
###############################################################################

on:
  push:
    branches: [ main, dev ]

jobs:
  build_upload:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup dotnet Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Pip Install paramiko
      run: pip install paramiko

    # 
    # dotnet publish "./logic/Client/Client.csproj" -c Release -r win-x64 -o ./THUAI6/win/win64 --self-contained true

    - name: Publish
      run: |
        mkdir -p THUAI6/win/win64        
        mkdir -p THUAI6/win/win64/Debug
        mkdir -p THUAI6/linux/linux64
        mkdir -p THUAI6/linux/linux64/Debug
        
        dotnet publish "./logic/Server/Server.csproj" -c Release -r win-x64 -o ./THUAI6/win/win64 --self-contained true
        dotnet publish "./logic/Server/Server.csproj" -c Debug -r win-x64 -o ./THUAI6/win/win64/Debug --self-contained true
        dotnet publish "./logic/Server/Server.csproj" -c Release -r linux-x64 -o ./THUAI6/linux/linux64 --self-contained true
        dotnet publish "./logic/Server/Server.csproj" -c Debug -r linux-x64 -o ./THUAI6/linux/linux64/Debug --self-contained true

        rm ./THUAI6/linux/linux64/System.*.dll
        rm ./THUAI6/linux/linux64/Debug/System.*.dll
        rm ./THUAI6/win/win64/System.*.dll
        rm ./THUAI6/win/win64/Debug/System.*.dll

        rm ./THUAI6/linux/linux64/*.so
        rm ./THUAI6/linux/linux64/Debug/*.so

    - name: Copy CAPI
      run: |
        mkdir -p THUAI6/win/CAPI/proto
        mkdir -p THUAI6/win/CAPI/cpp
        mkdir -p THUAI6/win/CAPI/python

        cp ./dependency/proto/Message2Clients.proto ./THUAI6/win/CAPI/proto/
        cp ./dependency/proto/Message2Server.proto ./THUAI6/win/CAPI/proto/
        cp ./dependency/proto/Services.proto ./THUAI6/win/CAPI/proto/
        cp ./dependency/proto/MessageType.proto ./THUAI6/win/CAPI/proto/

        cp -r ./CAPI/cpp/API ./THUAI6/win/CAPI/cpp
        cp -r ./CAPI/cpp/proto ./THUAI6/win/CAPI/cpp
        cp  ./CAPI/cpp/CAPI.sln ./THUAI6/win/CAPI/cpp
        cp  ./CAPI/cpp/CMakeLists.txt ./THUAI6/win/CAPI/cpp

        cp -r ./CAPI/python/PyAPI ./THUAI6/win/CAPI/python
        cp ./CAPI/python/requirements.txt ./THUAI6/win/CAPI/python

        cp -r ./THUAI6/win/CAPI ./THUAI6/linux/

    - name: Copy shell
      run: |
        cp -r ./CAPI/cmd/* ./THUAI6/win/
        cp -r ./CAPI/shell/* ./THUAI6/linux/

    - name: Upload COS
      uses: zkqiang/tencent-cos-action@v0.1.0
      with:
        args: upload -r ./THUAI6/ /
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        bucket: ${{ secrets.COS_BUCKET }}
        region: ${{ secrets.COS_REGION }}